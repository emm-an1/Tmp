node = NodeRegistry.get("oil_complex_fast_ws")

# Get mv and returns
mv = node.mv()
returns = node.instrument_returns()
instruments = node.instruments()

# Replicate pnl: sum of mv(t-1) * r(t)
replicated_pnl = sum(mv[inst].shift(1) * returns[inst] for inst in instruments)

# Get node's pnl
node_pnl = node.pnl()[node.name]

# Compare
print("First 10 values:")
print(pd.DataFrame({
    "replicated": replicated_pnl,
    "node_pnl": node_pnl,
    "diff": replicated_pnl - node_pnl
}).dropna().head(10))

print(f"\nMax absolute difference: {(replicated_pnl - node_pnl).abs().max()}")
print(f"Match: {(replicated_pnl - node_pnl).abs().max() < 1e-10}")
