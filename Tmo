from collections import defaultdict

# Build lookup: {instrument_id: {hl: node_name}}
nodes_by_instrument = defaultdict(dict)

for node in signal_nodes:
    instrument_id = node.instruments()[0]
    hl_str = node.name.split("_EMA")[-1]
    hl = int(hl_str)
    nodes_by_instrument[instrument_id][hl] = node.name

# Define speed groups
speed_groups = {
    "fast": [5, 10],
    "medium": [20, 40],
    "slow": [60, 120]
}

# Store created nodes
trend_nodes = []

# Create trend nodes for each instrument
for instrument_id, hl_nodes in nodes_by_instrument.items():
    for speed, hls in speed_groups.items():
        # Get predecessor names
        pred_names = [hl_nodes[hl] for hl in hls]
        
        # Weights all 1
        weights = {name: 1.0 for name in pred_names}
        
        # Number of signals for scaling
        n_signals = len(hls)
        
        # Weighted sum node
        ws_name = f"{instrument_id}_{speed}_ws"
        WeightedSumNode(
            name=ws_name,
            predecessors=pred_names,
            weights=weights
        )
        
        # Scale node (divide by n_signals)
        scaled_name = f"{instrument_id}_{speed}"
        scaled_node = ScalingNode(
            name=scaled_name,
            predecessors=[ws_name],
            multiplier=1.0 / n_signals
        )
        
        trend_nodes.append(scaled_node)

print(f"Created {len(trend_nodes)} trend nodes")
