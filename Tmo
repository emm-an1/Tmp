jp_fast = NodeRegistry.get("JP_equity_fast")

# --- Check 1: mv.shift(1) * returns = pnl ---
mv = jp_fast.mv()
returns = jp_fast.instrument_returns()
instruments = jp_fast.instruments()

manual_pnl = sum(mv[inst].shift(1) * returns[inst] for inst in instruments)
node_pnl = jp_fast.pnl()[jp_fast.name]

diff = (manual_pnl - node_pnl).abs().max()
print(f"Max pnl difference: {diff}")
print(f"PnL check passed: {diff < 1e-10 or pd.isna(diff)}")

# --- Check 2: Unit vol (std close to 1) ---
# Drop NaN warmup period
pnl_clean = node_pnl.dropna()
rolling_std = pnl_clean.rolling(252).std()

print(f"\nRolling 1Y std of pnl (should be ~1.0):")
print(f"  Mean: {rolling_std.mean():.4f}")
print(f"  Min:  {rolling_std.min():.4f}")
print(f"  Max:  {rolling_std.max():.4f}")

# Plot
import matplotlib.pyplot as plt

fig, axes = plt.subplots(2, 1, figsize=(12, 8))

# PnL comparison
axes[0].plot(manual_pnl, label='Manual: mv.shift(1) * returns', alpha=0.7)
axes[0].plot(node_pnl, label='Node pnl', alpha=0.7, linestyle='--')
axes[0].set_title('PnL check')
axes[0].legend()

# Rolling std
axes[1].plot(rolling_std)
axes[1].axhline(y=1.0, color='red', linestyle='--', label='Target = 1.0')
axes[1].set_title('Rolling 1Y std of pnl (should be ~1.0)')
axes[1].legend()

plt.tight_layout()
plt.show()


####
# tests/test_nodes.py

import pytest
import pandas as pd
import numpy as np

# Add src to path
import sys
sys.path.insert(0, 'src')

from portfolio_tree.NodeRegistry import NodeRegistry
from portfolio_tree.DataService import DataService
from portfolio_tree.nodes import (
    InstrumentNode, 
    WeightedSumNode, 
    ScalingNode,
    PrecomputedUVTrendSignalNode,
    CorrAdjustedUVScalingNode
)


@pytest.fixture(autouse=True)
def clear_registry():
    """Clear registry before each test."""
    NodeRegistry.clear()
    yield
    NodeRegistry.clear()


@pytest.fixture
def mock_data_service():
    """Create mock DataService with fake data."""
    dates = pd.date_range('2010-01-01', '2020-12-31', freq='B')
    
    # Create fake returns
    np.random.seed(42)
    returns_df = pd.DataFrame({
        'date': np.tile(dates, 2),
        'id': np.repeat(['A', 'B'], len(dates)),
        'r': np.random.randn(len(dates) * 2) * 0.01
    })
    
    ds = DataService.__new__(DataService)
    ds._returns_df = returns_df
    ds._full_df = returns_df
    
    return ds


class TestInstrumentNode:
    
    def test_mv_returns_ones(self, mock_data_service):
        InstrumentNode.set_data_service(mock_data_service)
        node = InstrumentNode(name='A')
        
        mv = node.mv()
        assert (mv['A'] == 1).all()
    
    def test_instruments(self, mock_data_service):
        InstrumentNode.set_data_service(mock_data_service)
        node = InstrumentNode(name='A')
        
        assert node.instruments() == ['A']


class TestWeightedSumNode:
    
    def test_mv_applies_weights(self, mock_data_service):
        InstrumentNode.set_data_service(mock_data_service)
        InstrumentNode(name='A')
        InstrumentNode(name='B')
        
        ws = WeightedSumNode(
            name='test_ws',
            predecessors=['A', 'B'],
            weights={'A': 2.0, 'B': 3.0}
        )
        
        mv = ws.mv()
        assert (mv['A'] == 2.0).all()
        assert (mv['B'] == 3.0).all()
    
    def test_pnl_calculation(self, mock_data_service):
        InstrumentNode.set_data_service(mock_data_service)
        node_a = InstrumentNode(name='A')
        node_b = InstrumentNode(name='B')
        
        ws = WeightedSumNode(
            name='test_ws',
            predecessors=['A', 'B'],
            weights={'A': 1.0, 'B': 1.0}
        )
        
        # Manual calculation
        mv = ws.mv()
        returns = ws.instrument_returns()
        manual_pnl = mv['A'].shift(1) * returns['A'] + mv['B'].shift(1) * returns['B']
        
        # Node calculation
        node_pnl = ws.pnl()['test_ws']
        
        # Compare (ignoring NaN)
        diff = (manual_pnl - node_pnl).abs().max()
        assert diff < 1e-10 or pd.isna(diff)


class TestScalingNode:
    
    def test_multiplier_applied(self, mock_data_service):
        InstrumentNode.set_data_service(mock_data_service)
        node_a = InstrumentNode(name='A')
        
        multiplier = pd.Series(0.5, index=node_a.mv().index)
        
        scaled = ScalingNode(
            name='A_scaled',
            predecessors=['A'],
            multiplier=multiplier
        )
        
        assert (scaled.mv()['A'] == 0.5).all()


class TestCorrAdjustedUVScalingNode:
    
    def test_pnl_near_unit_vol(self, mock_data_service):
        InstrumentNode.set_data_service(mock_data_service)
        InstrumentNode(name='A')
        InstrumentNode(name='B')
        
        ws = WeightedSumNode(
            name='test_ws',
            predecessors=['A', 'B'],
            weights={'A': 1.0, 'B': 1.0}
        )
        
        scaled = CorrAdjustedUVScalingNode(
            name='test_scaled',
            predecessors=['test_ws'],
            years=1  # shorter for test
        )
        
        pnl = scaled.pnl()['test_scaled'].dropna()
        rolling_std = pnl.rolling(252).std().dropna()
        
        # Should be close to 1.0
        assert rolling_std.mean() < 1.5
        assert rolling_std.mean() > 0.5

